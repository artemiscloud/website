<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Using the custom init image</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=description content="Introduction to the opterator custom init image"><meta name=author content="Themefisher"><meta name=generator content="Hugo 0.80.0"><link rel=stylesheet href=https://artemiscloud.github.io/website/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://artemiscloud.github.io/website/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://artemiscloud.github.io/website/plugins/slick/slick.css><link href=https://artemiscloud.github.io/website/scss/style.min.css rel=stylesheet media=screen><link rel="shortcut icon" href=https://artemiscloud.github.io/website/images/favicon.png type=image/x-icon><link rel=icon href=https://artemiscloud.github.io/website/images/favicon.png type=image/x-icon><meta property="og:title" content="Using the custom init image"><meta property="og:description" content="Introduction to the opterator custom init image"><meta property="og:type" content="article"><meta property="og:url" content="https://artemiscloud.github.io/website/blog/initcontainer/"></head><body><header class=navigation><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://artemiscloud.github.io/website/><img width=250px class=img-fluid src=https://artemiscloud.github.io/website/images/logo.png alt="Artemis Cloud"></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mx-auto"><li class=nav-item><a class=nav-link href=https://artemiscloud.github.io/website/blog>Blog</a></li><li class=nav-item><a class=nav-link href=https://artemiscloud.github.io/website/docs>Documentation</a></li><li class=nav-item><a class=nav-link href=https://artemiscloud.github.io/website/releases>Releases</a></li><li class=nav-item><a class=nav-link href=https://artemiscloud.github.io/website/community>Community</a></li></ul></div></nav></div></header><section class=section><div class=container><div class=row><div class="col-lg-8 mx-auto"><h2 class=mb-4>Using the custom init image</h2><div class=content><p>Starting from <a href=https://github.com/artemiscloud/activemq-artemis-operator/tree/v0.18.1 target=_blank>v0.18.1</a> the ActiveMQ Artemis Operator introduces a new feature called <strong>custom init image</strong> that allows users to do their own configuration of brokers within the operator framework.</p><h2 id=what-is-custom-init-image>What is Custom Init Image</h2><p>The custom init image is a user provided docker image that can be configured in the ActiveMQ Artemis broker custom resource file (CR). When the CR is deployed the ActiveMQ Artemis operator will search and run the post-configure script (if that exists in the custom init image) so that it can modify the broker instance pre-configured by the operator before the pod is started.</p><h2 id=how-it-works>How it works</h2><p>The ActiveMQ Artemis operator works with the broker&rsquo;s <a href=https://github.com/artemiscloud/activemq-artemis-operator/blob/v0.18.1/deploy/crds/broker_activemqartemis_crd.yaml target=_blank>CustomResourceDefinition(CRD)</a> that defines a set of parameters to configure brokers through the operator. For example user can define address settings in the <a href=https://github.com/artemiscloud/activemq-artemis-operator/blob/v0.18.1/deploy/examples/artemis-basic-address-settings-deployment.yaml target=_blank>CR file</a> and deploy it into the cluster. However the broker CRD doesn&rsquo;t cover every respects of a broker configuration. When a user needs to configure the broker that not available in the CRD, they have to find some homemade ways to so it. For example using S2I directly with the broker container image.</p><p>Internally the ActiveMQ Artemis operator uses an init container to configure each broker instance. If no custom init image is specified it uses the <a href=https://quay.io/repository/artemiscloud/activemq-artemis-broker-init target=_blank>built-in init image</a> which is responsible for the actual configuration. Once done the broker configuration is passed to the <a href=https://quay.io/repository/artemiscloud/activemq-artemis-broker-kubernetes target=_blank>broker container image</a> to launch the broker with it.</p><p>If a custom init image is specified in the CR, the operator installs it in place of the built-in init image. First the operator use this custom image as a built-in image to perform the configuration mentioned above, then it calls the post-config.sh script in the custom init image to start user provided custom configuration on top of the one produced by the built-in init image. The operator exposes the broker configuration instance location to the custom init image via a environment variable <strong>CONFIG_INSTANCE_DIR</strong>. In this location is a typical broker instance dir, whose structure is like</p><p><a name=instancedir></a></p><pre><code>${CONFIG_INSTANCE_DIR}
  |
  \--/bin
  \--/etc
  \--/data
  \--/lib
  \--/log
  \--/tmp
</code></pre><p>By the time the custom init image&rsquo;s post-config.sh is invoked the <strong>CONFIG_INSTANCE_DIR</strong> already contains all the configuration files generated by the built-in image (i.e. configurations from CR) and available for the custom init image&rsquo;s post-config.sh script to do extra configuration.</p><p>It can for example modify the logging settings and add/override some specific configurations in <strong>${CONFIG_INSTANCE_DIR}/etc</strong>. And if needed it can put extra runtime dependencies (jar files) to <strong>${CONFIG_INSTANCE_DIR}/lib</strong> so that the broker can load them into classpath.</p><p>After the post-config.sh is returned, the broker instance will be launched with the updated configuration.</p><h2 id=adding-a-custom-init-image>Adding a custom init image</h2><p>First you need to implement your custom init image.</p><p>The custom init image shall follow the predefined rules:</p><ul><li><p>The custom init image must take ActiveMQ Artemis operator&rsquo;s <a href=https://quay.io/repository/artemiscloud/activemq-artemis-broker-init target=_blank>built-in init image</a> as its base image in its docker file, for example</p><p>(Dockerfile):</p></li></ul><pre><code>   FROM quay.io/artemiscloud/activemq-artemis-broker-init:0.2.3
   ...
</code></pre><ul><li>The custom init image must put a post-config.sh script inside the image in the directory <strong>/amq/scripts</strong>. The absolute path therefore is <strong>/amq/scripts/post-config.sh</strong>.</li></ul><p>You need to prepare a <strong>post-config.sh</strong> script where you put in actions that does your custom configuration with the broker <a href=#instancedir>instance</a>.</p><p>If you need additional resources (xmls, jars, etc) for your custom configuration you need to add them to your image and make sure they are accessible for your post-config scripts.</p><p>Then you need to build it into a docker image and put it into a public container repository (for example you can create a repository on quay.io).</p><p>Edit your CR file and add the your custom init image. For example:</p><pre><code>apiVersion: broker.amq.io/v2alpha4
kind: ActiveMQArtemis
metadata:
  name: ex-aao
spec:
  deploymentPlan:
    size: 1
    image: quay.io/artemiscloud/activemq-artemis-broker-kubernetes:0.2.1
    initImage: &lt;your_custom_init_image_url&gt;
 ...
</code></pre><p>Finally deply the CR file.</p><h2 id=further-information>Further information</h2><ul><li><p>A fully working example is available <a href=https://github.com/artemiscloud/artemiscloud-examples/tree/main/operator/init/jdbc target=_blank>here</a></p></li><li><p>For issues/suggestions please raise it on <a href=https://github.com/artemiscloud/activemq-artemis-operator/issues target=_blank>artemiscloud</a></p></li></ul></div></div></div></div></section><footer class="bg-light section pb-0"><div class=container><div class=row><div class="col-md-3 col-sm-6 mb-10"><ul class="list-inline social-icons"><li class=list-inline-item><a href=https://twitter.com/theartemiscloud><i class=ti-twitter-alt></i></a></li><li class=list-inline-item>twitter</li><li class=list-inline-item><a href=https://github.com/ArtemisCloud><i class=ti-github></i></a></li><li class=list-inline-item>github</li></ul></div></div></div></footer><script src=https://artemiscloud.github.io/website/plugins/jQuery/jquery.min.js></script><script src=https://artemiscloud.github.io/website/plugins/bootstrap/bootstrap.min.js></script><script src=https://artemiscloud.github.io/website/plugins/slick/slick.min.js></script><script src=https://artemiscloud.github.io/website/js/script.min.js></script></body></html>