<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Using the custom init image</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=description content="Introduction to the operator custom init image"><meta name=author content="Themefisher"><meta name=generator content="Hugo 0.80.0"><link rel=stylesheet href=https://artemiscloud.github.io/website/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://artemiscloud.github.io/website/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://artemiscloud.github.io/website/plugins/slick/slick.css><link href=https://artemiscloud.github.io/website/scss/style.min.css rel=stylesheet media=screen><link rel="shortcut icon" href=https://artemiscloud.github.io/website/favicon.png type=image/x-icon><link rel=icon href=https://artemiscloud.github.io/website/favicon.png type=image/x-icon><meta property="og:title" content="Using the custom init image"><meta property="og:description" content="Introduction to the operator custom init image"><meta property="og:type" content="article"><meta property="og:url" content="https://artemiscloud.github.io/website/blog/initcontainer/"></head><body><header class=navigation><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://artemiscloud.github.io/website/><img width=250px class=img-fluid src=https://artemiscloud.github.io/website/images/logo.png alt="Artemis Cloud"></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mx-auto"><li class=nav-item><a class=nav-link href=https://artemiscloud.github.io/website/blog>Blog</a></li><li class=nav-item><a class=nav-link href=https://artemiscloud.github.io/website/docs>Documentation</a></li><li class=nav-item><a class=nav-link href=https://artemiscloud.github.io/website/releases>Releases</a></li><li class=nav-item><a class=nav-link href=https://artemiscloud.github.io/website/community>Community</a></li></ul></div></nav></div></header><section class=section><div class=container><div class=row><div class="col-lg-8 mx-auto"><h2 class=mb-4>Using the custom init image</h2><div class=content><p>Starting from <a href=https://github.com/artemiscloud/activemq-artemis-operator/tree/v0.18.1 target=_blank>v0.18.1</a>, the ArtemisCloud Operator
enables you to specify a <strong>custom Init Container image</strong>. Specifying a custom Init Container image allows you to provide your own broker configuration within the Operator framework.</p><h3 id=what-is-a-custom-init-container-image>What is a custom Init Container image?</h3><p>The ArtemisCloud Operator uses a <a href=https://github.com/artemiscloud/activemq-artemis-operator/blob/v0.18.1/deploy/crds/broker_activemqartemis_crd.yaml target=_blank>Custom Resource Definition (CRD)</a> to define the broker configuration. In Kubernetes, a CRD is a schema of configuration items or parameters. By creating a corresponding Custom Resource (CR) instance, you can specify values for configuration items in the CRD. For example, you can define address settings
in this <a href=https://github.com/artemiscloud/activemq-artemis-operator/blob/v0.18.1/deploy/examples/artemis-basic-address-settings-deployment.yaml target=_blank>sample CR file</a>.</p><p>For configuration that <em>isn&rsquo;t</em> exposed in the CRD, you can specify a custom Init Container image to manipulate or add to the configuration that has been created by the Operator. When the CR is deployed and the broker instance is created, the Operator will then run a user-provided post-configuration script.</p><h3 id=how-it-works>How it works</h3><p>Internally, the ArtemisCloud Operator uses a specialized container called an <em>Init Container</em> to configure each broker instance. If no custom image for the Init Container has been specified, the Operator uses a <a href=https://quay.io/repository/artemiscloud/activemq-artemis-broker-init target=_blank>built-in Init Container image</a>, which
is responsible for the configuration. The broker configuration generated by the Init Container is passed to the <a href=https://quay.io/repository/artemiscloud/activemq-artemis-broker-kubernetes target=_blank>broker container image</a> to use when launching the broker.</p><p>If a custom Init Container image <em>is</em> provided and specified in the Custom Resource (CR), then this is used to create the configuration. Since the custom image is built on top of the ArtemisCloud built-in Init Container image, the custom image first generates the broker configuration that is defined in the CR. Then, the Operator executes the post-configuration (<code>post-config.sh</code>) script provided by the custom Init Container.</p><p>For ease of use, the environment variable <code>CONFIG_INSTANCE_DIR</code> is set. This environment variable points to the broker instance directory, which has the following structure:</p><p><a name=instancedir></a></p><pre><code>${CONFIG_INSTANCE_DIR}
  |
  \--/bin
  \--/etc
  \--/data
  \--/lib
  \--/log
  \--/tmp
</code></pre><p>When the <code>post-config.sh</code> script is invoked, the directory specified in <code>CONFIG_INSTANCE_DIR</code> already contains all of the configuration
files generated by the built-in image (via the configuration specified in the CR) and is available for the <code>post-config.sh</code> script to do extra configuration.</p><p>For example, a custom Init Container might be used to modify the logging settings and add or override some specific configurations in <code>${CONFIG_INSTANCE_DIR}/etc</code>. In addition, the custom Init Container might put extra runtime dependencies (<code>.jar</code> files) in the <code>${CONFIG_INSTANCE_DIR}/lib</code> directory so that the broker can
use them.</p><p>After the <code>post-config.sh</code> script is executed, the broker instance is launched with the updated configuration.</p><h3 id=specifying-a-custom-init-container-image>Specifying a custom Init Container image</h3><ol><li><p>First, you need to implement your custom Init Container image.</p><p>The custom image should follow these predefined rules:</p><ul><li>The custom image must use the ArtemisCloud Operator&rsquo;s <a href=https://quay.io/repository/artemiscloud/activemq-artemis-broker-init target=_blank>built-in Init Container image</a> as the base image in its Docker file. For example:</li></ul><pre><code>FROM quay.io/artemiscloud/activemq-artemis-broker-init:0.2.3
...
</code></pre><ul><li>The custom image must include a <code>post-config.sh</code> script in the <code>/amq/scripts</code> directory. The absolute path will be <code>/amq/scripts/post-config.sh</code>.</li></ul><p>The <code>post-config.sh</code> script is where you modify the configuration of the broker or add any third party dependencies.</p><p>If you need additional resources (<code>.xml</code> files, <code>.jar</code> files, etc.) for your custom configuration, you need to add them to your image and make sure that they are accessible to your post-config scripts.</p></li><li><p>Next, you need to build your custom Init Container image and put it in a container repository (for example you can create a repository on <a href=quay.io>Red Hat Quay</a>).</p></li><li><p>When you have added the image to a repository, you need to configure the Operator to use the custom Init Container image. To do this, edit the CR file. For the <code>image</code> property, specify the custom image. For example:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>broker.amq.io/v2alpha4</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ActiveMQArtemis</span>
<span style=color:#f92672>metadata</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ex-aao</span>
    <span style=color:#f92672>spec</span>:
        <span style=color:#f92672>deploymentPlan</span>:
            <span style=color:#f92672>size</span>: <span style=color:#ae81ff>1</span>
            <span style=color:#f92672>image</span>: <span style=color:#ae81ff>quay.io/artemiscloud/activemq-artemis-broker-kubernetes:0.2.1</span>
            <span style=color:#f92672>initImage</span>: <span style=color:#ae81ff>&lt;your_custom_init_image_url&gt;</span>
            <span style=color:#ae81ff>...</span>
</code></pre></div></li><li><p>Finally, deploy the CR file in the usual manner. For more information, see <a href=https://artemiscloud.github.io/website/blog/using_operator/ title="About Us">Getting Started with the ArtemisCloud Operator</a>.</p></li></ol><h3 id=further-information>Further information</h3><ul><li><p>A fully working example is available <a href=https://github.com/artemiscloud/artemiscloud-examples/tree/main/operator/init/jdbc target=_blank>here</a>.</p></li><li><p>For issues or suggestions please open an issue at <a href=https://github.com/artemiscloud/activemq-artemis-operator/issues target=_blank>ArtemisCloud</a>.</p></li></ul></div></div></div></div></section><footer class="section pb-0"><div class=container><div class=row><div class="col-md-3 col-sm-6 mb-10"><ul class="list-inline social-icons"><li class=list-inline-item><a href=https://twitter.com/artemiscloudio><i class=ti-twitter-alt></i></a></li><li class=list-inline-item>twitter</li><li class=list-inline-item><a href=https://github.com/ArtemisCloud><i class=ti-github></i></a></li><li class=list-inline-item>github</li></ul></div></div></div></footer><script src=https://artemiscloud.github.io/website/plugins/jQuery/jquery.min.js></script><script src=https://artemiscloud.github.io/website/plugins/bootstrap/bootstrap.min.js></script><script src=https://artemiscloud.github.io/website/plugins/slick/slick.min.js></script><script src=https://artemiscloud.github.io/website/js/script.min.js></script></body></html>